<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>é˜¿ç“¦éš† Avalon â€” ç€è¦½å™¨æ¡ŒéŠï¼ˆå–®æ©Ÿ/å‚³éæ¨¡å¼ï¼‰</title>
    <style>
        :root {
            --bg: #0b1020;
            --panel: #121a2e;
            --muted: #7d8ab0;
            --txt: #eaf1ff;
            --good: #5fe1a1;
            --evil: #ff6b6b;
            --accent: #6ea8fe;
            --gold: #ffd166;
            --good-light: #b9f6ca;
            --evil-light: #ffb3b3;
            --neutral: #9fb5ff55;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            background: radial-gradient(1000px 600px at 20% -10%, #1a2550 0%, #0b1020 60%) no-repeat var(--bg);
            color: var(--txt);
            font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Noto Sans TC, "PingFang TC", Helvetica, Arial
        }

        h1,
        h2,
        h3 {
            margin: 0 0 .5rem
        }

        a {
            color: var(--gold)
        }

        .app {
            max-width: 1100px;
            margin: 0 auto;
            padding: 16px 16px 100px
        }

        .grid {
            display: grid;
            gap: 16px
        }

        .row {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .col {
            display: flex;
            flex-direction: column;
            gap: 12px
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
            border: 1px solid rgba(255, 255, 255, .08);
            border-radius: 16px;
            padding: 16px;
            backdrop-filter: blur(6px)
        }

        .pill {
            display: inline-flex;
            gap: 8px;
            align-items: center;
            border: 1px solid rgba(255, 255, 255, .12);
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 12px;
            color: var(--muted)
        }

        .btn {
            cursor: pointer;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 12px;
            background: #18243f;
            color: var(--txt);
            padding: 10px 14px;
            font-weight: 600;
            letter-spacing: .2px
        }

        .btn.secondary {
            background: #131a2b
        }

        .btn[disabled] {
            opacity: .6;
            cursor: not-allowed
        }

        .toolbar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap
        }

        .players {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px
        }

        .player {
            position: relative;
            background: #121a2e;
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 14px;
            padding: 10px
        }

        .player .top {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .player .name {
            font-weight: 700
        }

        .player .tag {
            font-size: 12px;
            color: var(--muted)
        }

        .player .role {
            margin-top: 8px;
            font-size: 13px;
            color: #bcd0ff
        }

        .chip {
            font-size: 12px;
            padding: 3px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, .15);
        }

        .chip.good {
            color: var(--good);
            border-color: rgba(95, 225, 161, .35)
        }

        .chip.evil {
            color: var(--evil);
            border-color: rgba(255, 107, 107, .35)
        }

        .is-leader {
            outline: 2px solid var(--gold)
        }

        .selectable {
            cursor: pointer;
            transition: transform .08s ease
        }

        .selectable:hover {
            transform: translateY(-1px)
        }

        .selected {
            box-shadow: 0 0 0 2px var(--accent) inset
        }

        .section-title {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-top: 8px
        }

        .log {
            white-space: pre-wrap;
            max-height: 220px;
            overflow: auto;
            background: #0f1528;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .08);
            padding: 10px
        }

        .stack {
            display: flex;
            flex-wrap: wrap;
            gap: 8px
        }

        .vote-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px
        }

        .approve {
            background: var(--good)
        }

        .reject {
            background: var(--evil)
        }

        .divider {
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, .1), transparent);
            margin: 8px 0
        }

        dialog {
            border: none;
            max-width: 520px;
            width: calc(100% - 32px);
            background: #0f1528;
            color: var(--txt);
            border-radius: 16px;
            padding: 0
        }

        dialog::backdrop {
            background: rgba(3, 6, 16, .6)
        }

        .dlg-body {
            padding: 16px
        }

        .dlg-head {
            padding: 14px 16px;
            background: #131c33;
            border-bottom: 1px solid rgba(255, 255, 255, .08);
            border-top-left-radius: 16px;
            border-top-right-radius: 16px
        }

        .kbd {
            font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
            background: #0e1324;
            border: 1px solid rgba(255, 255, 255, .12);
            border-radius: 6px;
            padding: 2px 6px;
            color: #cfe1ff
        }

        .hint {
            color: #a9b7de;
            font-size: 13px
        }

        /* ä»»å‹™é€²åº¦é¢æ¿ */
        .mission-board {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap
        }

        .mission-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #3a4569;
            border: 2px solid rgba(255, 255, 255, .2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #dfe7ff;
            font-size: 13px;
            font-weight: 700
        }

        .mission-dot.success {
            background: var(--good-light);
            color: #0b3d2e
        }

        .mission-dot.fail {
            background: var(--evil-light);
            color: #5b0000
        }

        .mission-dot.active {
            box-shadow: 0 0 0 2px var(--accent) inset;
            background: var(--neutral)
        }

        /* æœ¬è¼ªå‡ºç‰Œçµæœï¼ˆå¡ç‰‡è¦–è¦ºï¼‰ */
        .cards-board {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            min-height: 56px
        }

        .card-tile {
            width: 40px;
            height: 56px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, .18);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            background: #15203f
        }

        .card-tile.success {
            background: #163a2b;
            border-color: rgba(95, 225, 161, .3)
        }

        .card-tile.success::after {
            content: 'S';
            color: var(--good)
        }

        .card-tile.fail {
            background: #3a1b1b;
            border-color: rgba(255, 107, 107, .35)
        }

        .card-tile.fail::after {
            content: 'F';
            color: var(--evil)
        }

        .cards-hint {
            color: #a9b7de;
            font-size: 12px
        }
    </style>
</head>

<body>
    <div class="app">
        <header class="row" style="justify-content:space-between;align-items:flex-start">
            <div>
                <h1>é˜¿ç“¦éš† Avalon â€” ç€è¦½å™¨æ¡ŒéŠ</h1>
                <div class="pill">å–®æ©Ÿå‚³éï¼ˆHotseatï¼‰ï½œä¸é€£ç¶²è·¯ï½œæ”¯æ´ 5â€“10 äººã€ç¶“å…¸èˆ‡å¥³ç¥</div>
            </div>
            <div class="toolbar">
                <button class="btn" id="btnNew">ğŸ² åˆ†é…è§’è‰²</button>
                <button class="btn secondary" id="btnRules">â“ è¦å‰‡/å¿«æ·éµ</button>
            </div>
        </header>

        <section class="grid" style="grid-template-columns: 320px 1fr; margin-top:12px">
            <!-- æ§åˆ¶é¢æ¿ -->
            <div class="card col">
                <h3>è¨­å®š</h3>
                <label class="row" style="justify-content:space-between">
                    <span>ç©å®¶äººæ•¸</span>
                    <select id="playerCount">
                        <option>5</option>
                        <option>6</option>
                        <option>7</option>
                        <option selected>8</option>
                        <option>9</option>
                        <option>10</option>
                    </select>
                </label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥æ´¾è¥¿ç¶­çˆ¾</span><input type="checkbox"
                        id="optPercival" checked></label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥è«å¾·é›·å¾·</span><input type="checkbox"
                        id="optMordred" checked></label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥è«ç”˜å¨œ</span><input type="checkbox"
                        id="optMorgana" checked></label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥åˆºå®¢</span><input type="checkbox"
                        id="optAssassin" checked></label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥çˆªç‰™</span><input type="checkbox"
                        id="optMinion"></label>
                <label class="row" style="justify-content:space-between"><span>åŠ å…¥å¥§ä¼¯å€«</span><input type="checkbox"
                        id="optOberon"></label>
                <label class="row" style="justify-content:space-between"><span>æ¹–ä¸­å¥³ç¥</span><input type="checkbox"
                        id="optLady"></label>
                <div class="divider"></div>
                <div class="hint">å»ºè­°æµç¨‹ï¼š<span class="kbd">é…ç™¼</span> â†’ <span class="kbd">å¤œæ™š</span> â†’ é–‹å§‹ä»»å‹™èˆ‡æŠ•ç¥¨ã€‚</div>
                <div class="divider"></div>
                <div class="col">
                    <h3>æœ¬è¼ªç‹€æ…‹</h3>
                    <div>é ˜è¢–ï¼š<span id="leaderName" class="chip">â€”</span></div>
                    <div>ç›®å‰ä»»å‹™ï¼š<span id="missionIdx" class="chip">â€”</span>ï¼ˆéœ€ <span id="needPlayers">â€”</span> äººï¼‰</div>
                    <div>ææ¡ˆå¦æ±ºæ¬¡æ•¸ï¼š<span id="fails" class="chip">0</span> / 5</div>
                    <div>æˆ°ç¸¾ï¼š<span id="score" class="chip">â€”</span></div>
                    <!-- ä¾ä½ çš„è¦æ±‚ï¼šç§»é™¤ã€Œé–‹å§‹/æŠ•ç¥¨/åŸ·è¡Œä»»å‹™ã€ä¸‰å€‹æŒ‰éˆ• -->
                    <div class="divider"></div>
                    <div class="col">
                        <h3>ä»»å‹™é€²åº¦</h3>
                        <div id="missionBoard" class="mission-board"></div>
                    </div>
                </div>
            </div>

            <!-- ä¸»é¢æ¿ -->
            <div class="card col">
                <div class="section-title">
                    <h3>ç©å®¶å€</h3><span class="hint">é»é¸ä»¥åŠ å…¥/ç§»é™¤ä»»å‹™éšŠä¼</span>
                </div>
                <div class="players" id="players"></div>

                <div class="section-title">
                    <h3>ææ¡ˆ/ä»»å‹™æ§åˆ¶</h3>
                </div>
                <div class="row" style="gap:8px;flex-wrap:wrap">
                    <button class="btn" id="btnClearSel">æ¸…ç©ºé¸æ“‡</button>
                    <button class="btn" id="btnConfirmTeam">âœ… ç¢ºèªæœ¬æ¬¡ä»»å‹™æˆå“¡</button>
                    <span class="pill">ç›®å‰é¸æ“‡ï¼š<strong id="selectedCount">0</strong> äºº</span>
                    <span id="twoFailWarn"
                        style="display:none;font-size: 15px; margin-left:10px; color:rgb(255, 107, 107); font-weight:bold;"></span>
                </div>

                <div class="divider"></div>
                <!-- é€™è£¡æ–°å¢ï¼šæœ¬è¼ªå‡ºç‰Œçµæœé¢æ¿ï¼ˆåœ¨ç´€éŒ„ä¸Šæ–¹ï¼‰ -->
                <div class="section-title">
                    <h3>æœ¬è¼ªå‡ºç‰Œçµæœ</h3><span class="hint">å¤±æ•—å¡å„ªå…ˆé¡¯ç¤º</span>
                </div>
                <div id="cardsBoard" class="cards-board"><span class="cards-hint">ï¼ˆç­‰å¾…æœ¬è¼ªçµç®—ï¼‰</span></div>

                <div class="divider"></div>
                <div class="section-title">
                    <h3>ç´€éŒ„</h3><span class="hint">é›™æ“Šç´€éŒ„å¯è¤‡è£½</span>
                </div>
                <div id="log" class="log"></div>
            </div>
        </section>
    </div>

    <!-- é€šç”¨å°è©±æ¡† -->
    <dialog id="dlg">
        <div class="dlg-head"><strong id="dlgTitle">è¨Šæ¯</strong></div>
        <div class="dlg-body" id="dlgBody"></div>
        <div class="row" style="padding:0 16px 16px">
            <button class="btn" id="dlgClose">é—œé–‰</button>
        </div>
    </dialog>

    <script>
        (() => {
            const $ = (q, root = document) => root.querySelector(q);
            const logEl = $('#log');
            const dlg = $('#dlg'), dlgTitle = $('#dlgTitle'), dlgBody = $('#dlgBody');
            $('#dlgClose').onclick = () => dlg.close();

            const missionMatrix = { 5: [2, 3, 2, 3, 3], 6: [2, 3, 4, 3, 4], 7: [2, 3, 3, 4, 4], 8: [3, 4, 4, 5, 5], 9: [3, 4, 4, 5, 5], 10: [3, 4, 4, 5, 5] };
            const needsTwoFails = (pc, mi) => pc >= 7 && mi === 3;

            const ALL_ROLES = {
                Merlin: { name: 'æ¢…æ—', side: 'good' }, Percival: { name: 'æ´¾è¥¿ç¶­çˆ¾', side: 'good' }, Servant: { name: 'å¿ è‡£', side: 'good' },
                Mordred: { name: 'è«å¾·é›·å¾·', side: 'evil' }, Morgana: { name: 'è«ç”˜å¨œ', side: 'evil' }, Assassin: { name: 'åˆºå®¢', side: 'evil' }, Oberon: { name: 'å¥§ä¼¯å€«', side: 'evil' }, Minion: { name: 'å£äºº', side: 'evil' }
            };

            let S = {
                playerCount: 8, players: [], options: { Percival: true, Mordred: true, Morgana: true, Assassin: true, Oberon: false, Minion: false, Lady: false },
                leaderIdx: 0, missionIndex: 0, team: new Set(), voteHistory: [], missionHistory: [], failProposals: 0,
                lady: { enabled: false, holder: null, lastTarget: null, prevHolder: null },
                lastMissionCards: [] // e.g., ['F','F','S','S']ï¼Œé¡¯ç¤ºé †åºå·²å°‡å¤±æ•—æ”¾å‰é¢
            };

            function seedPlayers(n) {
                const names = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H', 'I', 'J'];
                S.players = Array.from({ length: n }, (_, i) => ({ id: i, name: names[i] || ('P' + (i + 1)), role: null, side: null, isLeader: false, seen: {} }));
            }
            function shuffle(a) { for (let i = a.length - 1; i > 0; i--) { const j = (Math.random() * (i + 1)) | 0;[a[i], a[j]] = [a[j], a[i]] } return a }

            function deal() {
                const n = S.playerCount; seedPlayers(n);
                const goodsBase = ['Merlin']; if (S.options.Percival) goodsBase.push('Percival');
                const evilBase = [];
                if (S.options.Morgana) evilBase.push('Morgana');
                if (S.options.Assassin) evilBase.push('Assassin');
                if (S.options.Mordred) evilBase.push('Mordred');
                if (S.options.Oberon) evilBase.push('Oberon');
                if (S.options.Minion) evilBase.push('Minion');
                const evilCount = Math.floor((n + 2) / 3); while (evilBase.length < evilCount) evilBase.push('Minion');
                const goodCount = n - evilCount; const goods = goodsBase.slice(); while (goods.length < goodCount) goods.push('Servant');
                const deck = goods.concat(evilBase).map(r => ALL_ROLES[r]); shuffle(deck);
                S.players.forEach((p, i) => { const r = deck[i]; p.role = r.name; p.side = r.side; });

                const merlin = S.players.find(p => p.role === 'æ¢…æ—');
                if (merlin) { merlin.seen.evil = S.players.filter(p => p.side === 'evil' && p.role !== 'å¥§ä¼¯å€«' && p.role !== 'è«å¾·é›·å¾·').map(p => p.name); }
                const percival = S.players.find(p => p.role === 'æ´¾è¥¿ç¶­çˆ¾');
                if (percival) { const candidates = S.players.filter(p => p.role === 'æ¢…æ—' || p.role === 'è«ç”˜å¨œ').map(p => p.name); percival.seen.wizards = shuffle(candidates.slice()); }
                S.players.forEach(p => { if (p.side === 'evil' && p.role !== 'å¥§ä¼¯å€«') { p.seen.evils = S.players.filter(q => q.side === 'evil' && q.role !== 'å¥§ä¼¯å€«' && q.id !== p.id).map(x => x.name); } });

                S.leaderIdx = 0; S.missionIndex = 0; S.failProposals = 0; S.team.clear(); S.voteHistory = []; S.missionHistory = [];
                S.lady.enabled = !!S.options.Lady;
                S.lady.holder = S.lady.enabled ? (S.playerCount - 1) : null;
                S.lady.lastTarget = null;
                S.lady.prevHolder = null;
                render(); addLog(`ğŸ² å·²é…ç™¼è§’è‰²ã€‚æ­£ç¾©æ–¹ ${goodCount} äººï¼Œé‚ªæƒ¡æ–¹ ${evilCount} äººã€‚è«‹ä¾åºã€ŒæŸ¥çœ‹ç§äººèº«ä»½ã€ã€‚`);
            }

            function addLog(text) { const ts = new Date().toLocaleTimeString('zh-TW', { hour12: false }); logEl.textContent += `[${ts}] ${text}\n`; logEl.scrollTop = logEl.scrollHeight; }

            function getLastApprovalFor(i) { if (!S.voteHistory.length) return null; const last = S.voteHistory[S.voteHistory.length - 1]; return (typeof last.approvals[i] === 'boolean') ? last.approvals[i] : null; }

            function renderMissionBoard() {
                const board = $('#missionBoard'); if (!board) return; board.innerHTML = '';
                for (let i = 0; i < 5; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'mission-dot';
                    const needCount = missionMatrix[S.playerCount][i];
                    dot.textContent = needCount;  // ç›´æ¥é¡¯ç¤ºéœ€è¦äººæ•¸
                    if (S.missionHistory[i]) {
                        dot.classList.add(S.missionHistory[i].success ? 'success' : 'fail');
                    }
                    else if (i === S.missionIndex) {
                        dot.classList.add('active');
                    }
                    board.appendChild(dot);


                }
            }

            function renderMissionCards() {
                const board = $('#cardsBoard'); if (!board) return; board.innerHTML = '';
                if (!S.lastMissionCards.length) { board.innerHTML = '<span class="cards-hint">ï¼ˆç­‰å¾…æœ¬è¼ªçµç®—ï¼‰</span>'; return; }
                S.lastMissionCards.forEach(c => { const el = document.createElement('div'); el.className = 'card-tile ' + (c === 'F' ? 'fail' : 'success'); board.appendChild(el); });
            }

            function render() {
                const cont = $('#players'); if (cont) {
                    cont.innerHTML = '';
                    S.players.forEach((p, i) => {
                        const lastVote = getLastApprovalFor(i);
                        const voteBadge = '';
                        const div = document.createElement('div');
                        div.className = 'player selectable' + (i === S.leaderIdx ? ' is-leader' : '') + (S.team.has(i) ? ' selected' : '');
                        div.dataset.id = i;
                        div.innerHTML = `
              <div class="top">
                <div class="name">${p.name}</div>
                <div class="row">${voteBadge}</div>
              </div>
              <div class="role">ï¼ˆé»æˆ‘ï¼šåŠ å…¥/ç§»é™¤ä»»å‹™ï¼›<a href="#" data-role="peek">ç§è¨Š</a>ï¼‰</div>
              <div class="tag">${p.role ? 'èº«åˆ†å·²ç™¼' : 'æœªé…ç™¼'}</div>`;
                        cont.appendChild(div);
                    });
                }
                $('#leaderName').textContent = S.players[S.leaderIdx]?.name ?? 'â€”';
                $('#missionIdx').textContent = (S.missionIndex + 1);
                $('#needPlayers').textContent = missionMatrix[S.playerCount][S.missionIndex];
                $('#fails').textContent = S.failProposals;
                // === ç¬¬4è¼ª + 7äººä»¥ä¸Š æé†’éœ€è¦å…©å¼µå¤±æ•—æ‰ç®—å¤±æ•— ===
                const warn = document.querySelector('#twoFailWarn');
                if (needsTwoFails(S.playerCount, S.missionIndex)) {
                    warn.style.display = 'inline-block';
                    warn.textContent = 'æ­¤ä»»å‹™éœ€è¦ 2 å¼µã€Œå¤±æ•—ã€å¡æ‰æœƒå¤±æ•—';
                } else {
                    warn.style.display = 'none';
                }

                const goodWins = S.missionHistory.filter(m => m.success).length; const evilWins = S.missionHistory.filter(m => !m.success).length;
                $('#score').textContent = `å¥½ ${goodWins}ï¼š${evilWins} å£`;
                $('#selectedCount').textContent = S.team.size;
                renderMissionBoard();
                renderMissionCards();
            }

            function openDialog(title, bodyEl) { dlgTitle.textContent = title; dlgBody.innerHTML = ''; dlgBody.appendChild(bodyEl); dlg.showModal(); }

            function showPrivate(id) {
                const p = S.players[id];
                const box = document.createElement('div'); box.className = 'col';
                const lines = [
                    `<div class="row" style="justify-content:space-between"><div><strong>${p.name}</strong> çš„ç§äººèº«ä»½</div><span class="chip ${p.side === 'good' ? 'good' : 'evil'}">${p.side === 'good' ? 'æ­£ç¾©' : 'é‚ªæƒ¡'}</span></div>`,
                    `<div class="divider"></div>`,
                    `<div>ä½ çš„è§’è‰²ï¼š<strong>${p.role}</strong></div>`
                ];
                if (p.role === 'æ¢…æ—') { lines.push(`<div class="hint">ä½ çœ‹åˆ°çš„å£äººï¼ˆä¸å«è«å¾·é›·å¾·ã€å¥§ä¼¯å€«ï¼‰ï¼š${p.seen.evil && p.seen.evil.length ? p.seen.evil.join('ã€') : 'ï¼ˆç„¡ï¼‰'}</div>`); }
                if (p.role === 'æ´¾è¥¿ç¶­çˆ¾') {
                    const sorted = p.seen.wizards ? p.seen.wizards.sort((a, b) => a.localeCompare(b)) : [];
                    lines.push(`<div class="hint">ä½ çœ‹åˆ°å…©é“å…‰èŠ’ï¼ˆæ¢…æ—/è«ç”˜å¨œï¼‰(æ²’æœ‰é †åº)ï¼š${sorted.length ? sorted.join('ã€') : 'ï¼ˆç„¡ï¼‰'}</div>`);
                } if (p.side === 'evil' && p.role !== 'å¥§ä¼¯å€«') { lines.push(`<div class="hint">ä½ çŸ¥é“çš„å£äººå¤¥ä¼´ï¼š${p.seen.evils && p.seen.evils.length ? p.seen.evils.join('ã€') : 'ï¼ˆç„¡ï¼‰'}</div>`); }
                box.innerHTML = lines.join('');
                openDialog('ç§äººèº«ä»½', box);
            }

            function startOrNext() { if (S.players.length === 0 || !S.players[0].role) { deal(); return; } S.team.clear(); render(); addLog(`ğŸ‘‘ é ˜è¢–æ˜¯ ${S.players[S.leaderIdx].name}ã€‚è«‹é¸å‡º ${missionMatrix[S.playerCount][S.missionIndex]} äººå‡ºä»»å‹™ã€‚`); }

            function confirmTeam() {
                const need = missionMatrix[S.playerCount][S.missionIndex];
                if (S.team.size !== need) { alert(`éœ€è¦é¸ ${need} äººï¼Œç›®å‰ ${S.team.size} äººã€‚`); return; }
                const box = document.createElement('div'); box.className = 'col';
                box.innerHTML = `<div>ç¢ºèªä»»å‹™éšŠä¼ï¼š<strong>${[...S.team].map(i => S.players[i].name).join('ã€')}</strong></div>`;
                const votes = [];
                S.players.forEach((p, i) => {
                    const row = document.createElement('div'); row.className = 'row'; row.style.justifyContent = 'space-between';
                    row.innerHTML = `<div>${p.name}</div>`;
                    const btns = document.createElement('div'); btns.className = 'row'; btns.style.gap = '6px';
                    const b1 = document.createElement('button'); b1.className = 'btn'; b1.textContent = 'è´Šæˆ';
                    const b2 = document.createElement('button'); b2.className = 'btn secondary'; b2.textContent = 'åå°';
                    b1.onclick = () => { votes[i] = true; mark(); };
                    b2.onclick = () => { votes[i] = false; mark(); };
                    function mark() { b1.style.outline = votes[i] === true ? '2px solid var(--good)' : ''; b2.style.outline = votes[i] === false ? '2px solid var(--evil)' : '' }
                    btns.append(b1, b2); row.appendChild(btns); box.appendChild(row);
                });
                const submit = document.createElement('button'); submit.className = 'btn'; submit.textContent = 'é€å‡ºæŠ•ç¥¨çµæœ';
                submit.onclick = () => {
                    if (votes.some(v => v === undefined)) { if (!confirm('ä»æœ‰äººæœªæŠ•ç¥¨ï¼Œç¢ºå®šé€å‡ºï¼Ÿ')) return; }
                    const approvals = votes.map(v => !!v);
                    const yes = approvals.filter(Boolean).length; const no = approvals.length - yes;
                    const passed = yes > no; // å¹³æ‰‹è¦–ç‚ºå¦æ±º
                    S.voteHistory.push({ leader: S.leaderIdx, team: [...S.team], approvals, passed });
                    if (passed) { addLog(`ğŸ—³ï¸ æŠ•ç¥¨é€šéï¼ˆ${yes} è´Šæˆ / ${no} åå°ï¼‰`); dlg.close(); executeMission(); }
                    else { addLog(`ğŸ—³ï¸ æŠ•ç¥¨å¦æ±ºï¼ˆ${yes} è´Šæˆ / ${no} åå°ï¼‰`); S.failProposals++; dlg.close(); if (S.failProposals >= 5) { endGame('evil', 'é€£çºŒ 5 æ¬¡å¦æ±ºï¼Œé‚ªæƒ¡æ–¹å‹åˆ©'); return; } S.leaderIdx = (S.leaderIdx + 1) % S.players.length; S.team.clear(); render(); }
                    render();
                };
                box.appendChild(document.createElement('div')).className = 'divider';
                box.appendChild(submit);
                openDialog('æŠ•ç¥¨ â€” è´Šæˆ/åå°', box);
            }

            function executeMission() {
                const team = [...S.team];
                const twoFailNeeded = needsTwoFails(S.playerCount, S.missionIndex);
                const choices = {}; let idx = 0;
                const step = () => {
                    if (idx >= team.length) {
                        const arr = team.map(i => choices[i] || 'S');
                        const fails = arr.filter(x => 'F' === x).length;
                        const success = twoFailNeeded ? (fails < 2) : (fails === 0);
                        S.missionHistory.push({ team: team.slice(), fails, success });

                        // æ§‹é€ æœ¬è¼ªå‡ºç‰Œé¡¯ç¤ºï¼šå¤±æ•—åœ¨å‰ï¼ŒæˆåŠŸåœ¨å¾Œ
                        const cards = new Array(fails).fill('F').concat(new Array(team.length - fails).fill('S'));
                        S.lastMissionCards = cards;
                        render(); // å…ˆåˆ·æ–°é¢æ¿ï¼Œå†é—œé–‰æ¡†

                        // addLog(`ğŸ›¡ï¸ ä»»å‹™çµæœï¼š${success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}ï¼ˆå¤±æ•—å¡ ${fails}ï¼‰`);
                        dlg.close();

                        // å‹è² åˆ¤æ–·
                        if (success && S.missionHistory.filter(m => m.success).length >= 3) { const assassin = S.players.find(p => p.role === 'åˆºå®¢'); if (assassin) { openAssassination(); } else { endGame('good', 'ä¸‰æ¬¡ä»»å‹™æˆåŠŸ'); } return; }
                        if (!success && S.missionHistory.filter(m => !m.success).length >= 3) { endGame('evil', 'ä¸‰æ¬¡ä»»å‹™å¤±æ•—'); return; }

                        const mIdx = S.missionIndex; if (S.lady.enabled && (mIdx === 1 || mIdx === 2 || mIdx === 3)) { openLady(); } else { nextLeaderAndMission(); }
                        return;
                    }
                    const pid = team[idx]; const p = S.players[pid];
                    const box = document.createElement('div'); box.className = 'col';
                    box.innerHTML = `
            <div>è«‹ <strong>${p.name}</strong> ç¨è‡ªæŸ¥çœ‹ä¸¦é¸æ“‡ä½ çš„ä»»å‹™å¡ã€‚</div>
            <div class="hint">ï¼ˆæŠŠè£ç½®äº¤çµ¦ ${p.name}ï¼Œå…¶ä»–äººè«‹è½‰é ­æˆ–é–‰çœ¼ã€‚é¸æ“‡å¾Œç³»çµ±æœƒè‡ªå‹•åˆ‡æ›åˆ°ä¸‹ä¸€ä½ã€‚ï¼‰</div>
            ${twoFailNeeded ? '<span class="pill">æ­¤ä»»å‹™éœ€è¦å…©å¼µå¤±æ•—å¡æ‰ç®—å¤±æ•—</span>' : ''}
          `;
                    const btnRow = document.createElement('div'); btnRow.className = 'row'; btnRow.style.gap = '8px';
                    const bSucc = document.createElement('button'); bSucc.className = 'btn'; bSucc.textContent = 'âœ… æˆåŠŸ';
                    const bFail = document.createElement('button'); bFail.className = 'btn secondary'; bFail.textContent = 'âŒ å¤±æ•—';
                    bSucc.onclick = () => { choices[pid] = 'S'; idx++; step(); };
                    bFail.onclick = () => { if (p.side === 'evil') { choices[pid] = 'F'; idx++; step(); } else { alert('æ­£ç¾©æ–¹ä¸èƒ½å‡ºå¤±æ•—å¡'); } };
                    btnRow.append(bSucc, bFail); box.appendChild(btnRow);
                    openDialog(`ä»»å‹™æŠ•ç¥¨ï¼ˆç¬¬ ${idx + 1}/${team.length} ä½ï¼‰`, box);
                };
                step();
            }

            function nextLeaderAndMission() { S.leaderIdx = (S.leaderIdx + 1) % S.players.length; S.missionIndex++; S.team.clear(); S.failProposals = 0; render(); addLog(`â–¶ï¸ é€²å…¥ä»»å‹™ ${S.missionIndex + 1} ã€‚ğŸ‘‘ é ˜è¢–æ˜¯ ${S.players[S.leaderIdx].name}ã€‚è«‹é¸å‡º ${missionMatrix[S.playerCount][S.missionIndex]} äººå‡ºä»»å‹™ã€‚`); }
            function openLady() {
                if (!S.lady.enabled) return nextLeaderAndMission();
                const holder = S.players[S.lady.holder];
                const box = document.createElement('div'); box.className = 'col';
                box.innerHTML = `<div>æ¹–ä¸­å¥³ç¥ç”± <strong>${holder.name}</strong> æŒæœ‰ã€‚é¸æ“‡è¦æŸ¥é©—çš„ç©å®¶ï¼ˆåƒ…é¡¯ç¤ºé™£ç‡Ÿï¼‰ã€‚</div>`;
                const list = document.createElement('div'); list.className = 'stack';
                S.players.forEach((p, i) => {
                    if (i === S.lady.holder) return;
                    const btn = document.createElement('button');
                    btn.className = 'btn secondary';
                    // ä¸å¯æŸ¥é©—ä¸Šä¸€è¼ªçš„æŒæœ‰è€…
                    if (S.lady.prevHolder !== null && i === S.lady.prevHolder) {
                        btn.disabled = true;
                        btn.textContent = `${p.name}ï¼ˆä¸å¯æŸ¥é©—ï¼šä¸Šä¸€è¼ªæŒæœ‰è€…ï¼‰`;
                    } else {
                        btn.textContent = p.name;
                        btn.onclick = () => {
                            const res = p.side === 'good' ? 'æ­£ç¾©' : 'é‚ªæƒ¡';
                            alert(`${p.name} çš„é™£ç‡Ÿæ˜¯ï¼š${res}`);
                            S.lady.lastTarget = i;
                            // è¨˜éŒ„ä¸Šä¸€ä»»æŒæœ‰è€…ï¼Œå†æŠŠä»¤äº¤çµ¦è¢«æŸ¥è€…
                            S.lady.prevHolder = S.lady.holder;
                            S.lady.holder = i;
                            dlg.close();
                            nextLeaderAndMission();
                        };
                    }
                    list.appendChild(btn);
                });
                box.appendChild(list);
                openDialog('æ¹–ä¸­å¥³ç¥', box);
            }
            function openAssassination() { const box = document.createElement('div'); box.className = 'col'; box.innerHTML = '<div>é‚ªæƒ¡æ–¹ç²å¾—åˆºæ®ºæ©Ÿæœƒã€‚è«‹åˆºå®¢æŒ‡å®šä»–èªç‚ºæ˜¯ <strong>æ¢…æ—</strong> çš„ç©å®¶ã€‚</div>'; const list = document.createElement('div'); list.className = 'stack'; S.players.forEach((p, i) => { const btn = document.createElement('button'); btn.className = 'btn secondary'; btn.textContent = p.name; btn.onclick = () => { const isMerlin = p.role === 'æ¢…æ—'; dlg.close(); if (isMerlin) { endGame('evil', `åˆºå®¢åˆºä¸­æ¢…æ—ï¼ˆ${p.name}ï¼‰`); } else { endGame('good', `åˆºå®¢åˆºéŒ¯ï¼ˆ${p.name}ï¼‰`); } }; list.appendChild(btn); }); box.appendChild(list); openDialog('åˆºæ®ºéšæ®µ', box); }

            // çµæŸæ™‚ä¸é¡¯ç¤ºèº«ä»½ï¼Œåªé¡¯ç¤ºå‹è² èˆ‡æˆ°ç¸¾
            function endGame(winner, reason) {
                render();
                const box = document.createElement('div'); box.className = 'col';
                const goodWins = S.missionHistory.filter(m => m.success).length; const evilWins = S.missionHistory.filter(m => !m.success).length;
                box.innerHTML = `<div class="row" style="gap:8px;align-items:center"><h3>${winner === 'good' ? 'ğŸ† æ­£ç¾©æ–¹å‹åˆ©' : 'ğŸ’€ é‚ªæƒ¡æ–¹å‹åˆ©'}</h3><span class="pill">${reason}</span></div>`;
                ///   <div>æœ€çµ‚æˆ°ç¸¾ï¼šå¥½ ${goodWins}ï¼š${evilWins} å£</div>`;
                openDialog('éŠæˆ²çµæŸ', box);
                addLog(`ğŸ éŠæˆ²çµæŸï¼š${winner === 'good' ? 'æ­£ç¾©æ–¹å‹åˆ©' : 'é‚ªæƒ¡æ–¹å‹åˆ©'}ï¼ˆ${reason}ï¼‰`);

                box.innerHTML += `<div><strong>èº«ä»½æ­æ›‰</strong></div>`;
                const list = document.createElement('div'); list.className = 'players';
                S.players.forEach(p => { const dv = document.createElement('div'); dv.className = 'player'; dv.innerHTML = `<div class="top"><div class="name">${p.name}</div><span class="chip ${p.side === 'good' ? 'good' : 'evil'}">${p.side === 'good' ? 'æ­£ç¾©' : 'é‚ªæƒ¡'}</span></div><div class="role">${p.role}</div>`; list.appendChild(dv); }); box.appendChild(list);
            }

            // UI ç¶å®š
            $('#playerCount').onchange = e => { S.playerCount = +e.target.value; render(); }
            $('#optPercival').onchange = e => S.options.Percival = e.target.checked;
            $('#optMordred').onchange = e => S.options.Mordred = e.target.checked;
            $('#optMorgana').onchange = e => S.options.Morgana = e.target.checked;
            $('#optAssassin').onchange = e => S.options.Assassin = e.target.checked;
            $('#optMinion').onchange = e => S.options.Minion = e.target.checked;
            $('#optOberon').onchange = e => S.options.Oberon = e.target.checked;
            $('#optLady').onchange = e => S.options.Lady = e.target.checked;

            $('#btnNew').onclick = deal;
            // å·¦å´ä¸‰éµå·²æ‹¿æ‰ï¼Œä½†å¿«æ·éµä»å¯ç”¨
            window.addEventListener('keydown', (e) => {
                if (e.key === 'n' || e.key === 'N') { e.preventDefault(); startOrNext(); }
                if (e.key === 'v' || e.key === 'V') { e.preventDefault(); confirmTeam(); }
                if (e.key === 'e' || e.key === 'E') { e.preventDefault(); executeMission(); }
            });

            $('#btnClearSel').onclick = () => { S.team.clear(); render(); };
            $('#btnConfirmTeam').onclick = confirmTeam;

            $('#players').addEventListener('click', (e) => {
                const a = e.target.closest('a[data-role="peek"]');
                if (a) { e.preventDefault(); const card = e.target.closest('.player'); showPrivate(+card.dataset.id); return; }
                const card = e.target.closest('.player'); if (!card) return; const id = +card.dataset.id;
                if (S.team.has(id)) S.team.delete(id); else S.team.add(id); render();
            });

            $('#btnRules').onclick = () => {
                const box = document.createElement('div'); box.className = 'col';
                box.innerHTML = `
      <div><strong>éŠæˆ²æµç¨‹</strong></div>
      <ul>
        <div class="step">
          <strong>1. è¨­å®šï¼š</strong>é¸æ“‡éŠç©äººæ•¸èˆ‡è§’è‰²ï¼Œé»æ“Šã€Œåˆ†é…è§’è‰²ã€é…ç™¼ã€‚
        </div>
        <div class="step">
          <strong>2. æŸ¥çœ‹èº«ä»½ï¼š</strong>ä¾åºé»æ“Šç©å®¶å¡ç‰‡ä¸Šçš„ã€Œç§è¨Šã€æŒ‰éˆ•æŸ¥çœ‹è‡ªå·±çš„è§’è‰²ã€‚
        </div>
        <div class="step">
          <strong>3â€“5. é‡è¤‡ä»»å‹™è¼ªæ¬¡ï¼š</strong>
          <ul style="margin: 6px 0">
            <li>é ˜è¢–é¸æ“‡ä»»å‹™éšŠä¼ï¼ˆé»æ“Šç©å®¶å¡ç‰‡åŠ å…¥/ç§»é™¤ï¼‰</li>
            <li>ç¢ºèªéšŠä¼ä¸¦æŠ•ç¥¨ï¼ˆå…¨é«”è´Šæˆ/åå°ï¼‰</li>
            <li>éšŠä¼æˆå“¡ä¾åºé¸æ“‡ã€ŒæˆåŠŸ/å¤±æ•—ã€å¡</li>
            <div class="hint">ï¼ï¼ï¼æŒ‰ä¸€æ¬¡å°±å¥½ï¼ï¼ï¼</div>
            <li>ç›´åˆ°æŸæ–¹ç²å‹ï¼ˆ3 æ¬¡æˆåŠŸ / 3 æ¬¡å¤±æ•— / 5 æ¬¡å¦æ±ºï¼‰</li>
          </ul>
        </div>
      </ul>
      <div class="divider"></div>

      <div><strong>è§’è‰²åŠŸèƒ½ç°¡è¿°</strong></div>
      <ul>
        <div style="font-weight: bold; color: #28a745; margin-bottom: 10px;">å¥½äººé™£ç‡Ÿï¼š</div>
        <li><strong>å¿ è‡£</strong> â€” ç„¡ç‰¹æ®Šèƒ½åŠ›ã€‚</li>
        <li><strong>æ¢…æ—</strong> â€” çŸ¥é“æ‰€æœ‰å£äººï¼ˆçœ‹ä¸åˆ°è«å¾·é›·å¾·èˆ‡å¥§ä¼¯å€«ï¼‰ã€‚</li>
        <li><strong>æ´¾è¥¿ç¶­çˆ¾</strong> â€” çŸ¥é“æ¢…æ—å’Œè«ç”˜å¨œæ˜¯èª°ã€‚</li>
        <div style="font-weight: bold; color: #dc3545; margin-top: 20px; margin-bottom: 10px;">é‚ªæƒ¡é™£ç‡Ÿï¼š</div>
        <li><strong>è«å¾·é›·å¾·</strong> â€” æ¢…æ—ç„¡æ³•è­˜åˆ¥ä»–ã€‚</li>
        <li><strong>è«ç”˜å¨œ</strong> â€” æœƒè¢«èª¤èªç‚ºæ¢…æ—ã€‚</li>
        <li><strong>åˆºå®¢</strong> â€” éŠæˆ²çµæŸå¾Œå¯å˜—è©¦åˆºæ®ºä¸€ä½ç©å®¶ï¼Œè‹¥åˆºä¸­æ¢…æ—å‰‡é‚ªæƒ¡å‹åˆ©ã€‚</li>
        <li><strong>çˆªç‰™</strong> â€” ç„¡ç‰¹æ®Šèƒ½åŠ›ã€‚</li>
        <li><strong>å¥§ä¼¯å€«</strong> â€” å…¶ä»–å£äººä¸çŸ¥é“ä»–çš„èº«ä»½ï¼Œä»–ä¹Ÿä¸çŸ¥é“å…¶ä»–å£äººæ˜¯èª°ã€‚</li>
      </ul>

      <div class="divider"></div>
      <div><strong>å¿«é€Ÿè¦å‰‡</strong></div>
      <ul>
        <li>æ¯è¼ªç”± <b>é ˜è¢–</b> ææ¡ˆä»»å‹™éšŠä¼ï¼Œæ‰€æœ‰äººæŠ•ç¥¨ï¼ˆå¹³æ‰‹è¦–ç‚ºå¦æ±ºï¼‰ã€‚é€£çºŒ 5 æ¬¡å¦æ±º â†’ é‚ªæƒ¡æ–¹å‹ã€‚</li>
        <li>ä»»å‹™éšŠä¼æˆå“¡ç§˜å¯†é¸æ“‡ã€ŒæˆåŠŸ/å¤±æ•—ã€ã€‚é‚ªæƒ¡æ‰èƒ½å‡ºå¤±æ•—ï¼›ç¬¬ 4 ä»»å‹™åœ¨ 7+ äººå±€éœ€ <em>å…©å¼µå¤±æ•—</em> æ‰ç®—å¤±æ•—ã€‚</li>
        <li>ä¸‰æ¬¡ä»»å‹™æˆåŠŸ â†’ æ­£ç¾©æ–¹å‹ï¼›ä¸‰æ¬¡å¤±æ•— â†’ é‚ªæƒ¡æ–¹å‹ï¼ˆè‹¥æœ‰åˆºå®¢å‰‡é€²å…¥åˆºæ®ºéšæ®µï¼‰ã€‚</li>
        <li>æ¹–ä¸­å¥³ç¥ï¼ˆè‹¥å•Ÿç”¨ï¼‰åœ¨ä»»å‹™ 2/3/4 å¾Œç™¼å‹•ï¼ŒæŸ¥é©—é™£ç‡Ÿä¸¦æŠŠä»¤äº¤çµ¦è¢«æŸ¥è€…ã€‚</li>
      </ul>
      <div class="divider"></div>
      <div><strong>å°æŠ€å·§</strong></div>
      <ul>
        <li>æ²¿ç”¨å‰›æˆåŠŸçš„æ ¸å¿ƒéšŠä¼é€šå¸¸æ›´ç©©ã€‚</li>
        <li>è§€å¯ŸæŠ•ç¥¨è¡Œç‚ºä¸€è‡´æ€§ï¼›å£äººå¸¸æˆç¾¤æŠ•ç¥¨ã€‚</li>
        <li>æ¢…æ—ç™¼è¨€è¦ã€Œæº–ä½†ä¸å¤ªæº–ã€ï¼›æ´¾è¥¿ç¶­çˆ¾è² è²¬å¸åˆ€ã€‚</li>
      </ul>
      <div class="divider"></div>
      <div>å¿«æ·éµï¼š<span class="kbd">N</span> é…ç™¼ã€<span class="kbd">V</span> æŠ•ç¥¨ã€<span class="kbd">E</span> åŸ·è¡Œä»»å‹™</div>
    `;
                openDialog('è¦å‰‡/æç¤º', box);
            };

            // Init
            S.playerCount = +$('#playerCount').value; seedPlayers(S.playerCount); render(); addLog('æ­¡è¿ä¾†åˆ°é˜¿ç“¦éš†ï¼è«‹å…ˆã€Œé…ç™¼è§’è‰²ã€ï¼Œå†ä¾åºæŸ¥çœ‹ç§äººèº«ä»½ã€‚');
        })();
    </script>
</body>

</html>