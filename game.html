<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é˜¿ç“¦éš† Online - å¤šäººé€£ç·šç‰ˆ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body {
            background-color: #0b1020;
            color: #f1f5f9;
        }

        .loader {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import {
            getFirestore, collection, doc, setDoc, getDoc, updateDoc,
            onSnapshot, runTransaction, arrayUnion
        } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const { useState, useEffect, useMemo } = React;

        // --- USER CONFIGURATION ---
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyA4sDlsmd6HjQT4dpEAEBuVYKtKnmxmAZI",
            authDomain: "avalon-b2ea5.firebaseapp.com",
            projectId: "avalon-b2ea5",
            storageBucket: "avalon-b2ea5.firebasestorage.app",
            messagingSenderId: "170894045462",
            appId: "1:170894045462:web:cfa2b06e23f3e28bb1e037",
            measurementId: "G-6ZXMRVDW8Y"
        };

        // --- Icons ---
        const createLucideIcon = (name) => ({ size = 24, className = "", ...props }) => {
            const iconDef = lucide.icons[name];
            if (!iconDef) return null;
            return React.createElement("svg", {
                xmlns: "http://www.w3.org/2000/svg",
                width: size, height: size, viewBox: "0 0 24 24",
                fill: "none", stroke: "currentColor", strokeWidth: 2,
                strokeLinecap: "round", strokeLinejoin: "round", className: className,
                ...props
            }, ...iconDef.map(([tag, attrs], i) => React.createElement(tag, { ...attrs, key: i })));
        };

        const Users = createLucideIcon("Users");
        const Crown = createLucideIcon("Crown");
        const Shield = createLucideIcon("Shield");
        const Check = createLucideIcon("Check");
        const X = createLucideIcon("X");
        const Play = createLucideIcon("Play");
        const Copy = createLucideIcon("Copy");
        const ArrowUp = createLucideIcon("ArrowUp");
        const ArrowDown = createLucideIcon("ArrowDown");
        const Eye = createLucideIcon("Eye");
        const EyeOff = createLucideIcon("EyeOff");
        const RefreshCw = createLucideIcon("RefreshCw");
        const Sparkles = createLucideIcon("Sparkles");

        // --- Components ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800/80 backdrop-blur-md border border-slate-700 rounded-xl p-4 shadow-xl ${className}`}>
                {children}
            </div>
        );

        const Button = ({ onClick, children, variant = 'primary', disabled = false, className = '' }) => {
            const base = "px-4 py-2 rounded-lg font-bold transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2";
            const styles = {
                primary: "bg-blue-600 hover:bg-blue-500 text-white shadow-lg shadow-blue-900/50",
                secondary: "bg-slate-700 hover:bg-slate-600 text-slate-200",
                danger: "bg-red-600 hover:bg-red-500 text-white shadow-lg shadow-red-900/50",
                success: "bg-emerald-600 hover:bg-emerald-500 text-white shadow-lg shadow-emerald-900/50",
                warning: "bg-amber-600 hover:bg-amber-500 text-white shadow-lg shadow-amber-900/50",
            };
            return (
                <button onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className}`}>
                    {disabled && variant !== 'secondary' ? <div className="loader"></div> : children}
                </button>
            );
        };

        const Badge = ({ children, type = 'neutral' }) => {
            const styles = {
                good: "bg-emerald-900/50 text-emerald-400 border-emerald-700",
                evil: "bg-red-900/50 text-red-400 border-red-700",
                neutral: "bg-slate-700 text-slate-300 border-slate-600",
            };
            return <span className={`text-xs px-2 py-0.5 rounded-full border ${styles[type]}`}>{children}</span>;
        };

        // --- Game Logic ---
        const ROLES_CONFIG = {
            Merlin: { name: 'æ¢…æ—', side: 'good', label: 'æ­£ç¾©' },
            Percival: { name: 'æ´¾è¥¿ç¶­çˆ¾', side: 'good', label: 'æ­£ç¾©' },
            Servant: { name: 'å¿ è‡£', side: 'good', label: 'æ­£ç¾©' },
            Mordred: { name: 'è«å¾·é›·å¾·', side: 'evil', label: 'é‚ªæƒ¡' },
            Morgana: { name: 'è«ç”˜å¨œ', side: 'evil', label: 'é‚ªæƒ¡' },
            Assassin: { name: 'åˆºå®¢', side: 'evil', label: 'é‚ªæƒ¡' },
            Oberon: { name: 'å¥§ä¼¯å€«', side: 'evil', label: 'é‚ªæƒ¡' },
            Minion: { name: 'çˆªç‰™', side: 'evil', label: 'é‚ªæƒ¡' },
        };

        const MISSION_MATRIX = {
            5: [2, 3, 2, 3, 3],
            6: [2, 3, 4, 3, 4],
            7: [2, 3, 3, 4, 4],
            8: [3, 4, 4, 5, 5],
            9: [3, 4, 4, 5, 5],
            10: [3, 4, 4, 5, 5]
        };

        const App = () => {
            const [appInstance, setAppInstance] = useState(null);
            const [user, setUser] = useState(null);
            const [roomCode, setRoomCode] = useState('');
            const [playerName, setPlayerName] = useState('');
            const [roomData, setRoomData] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');
            const [copySuccess, setCopySuccess] = useState(false);

            useEffect(() => {
                try {
                    const app = initializeApp(FIREBASE_CONFIG);
                    const auth = getAuth(app);
                    signInAnonymously(auth).catch(err => setError(err.message));
                    onAuthStateChanged(auth, u => setUser(u));
                    setAppInstance(app);
                } catch (e) { setError("Firebase Init Error"); }
            }, []);

            useEffect(() => {
                if (!user || !roomCode || !appInstance) return;
                const db = getFirestore(appInstance);
                const unsub = onSnapshot(doc(db, 'avalon_rooms', roomCode), (snap) => {
                    if (snap.exists()) { setRoomData(snap.data()); setLoading(false); }
                    else { setRoomData(null); setLoading(false); }
                }, err => setError(err.message));
                return () => unsub();
            }, [user, roomCode, appInstance]);

            const getDb = () => getFirestore(appInstance);

            const copyToClipboard = (text) => {
                navigator.clipboard.writeText(text).then(() => {
                    setCopySuccess(true); setTimeout(() => setCopySuccess(false), 2000);
                });
            };

            const createRoom = async () => {
                if (!playerName.trim()) return setError('è«‹è¼¸å…¥æš±ç¨±');
                setLoading(true);
                const db = getDb();
                const code = Math.floor(1000 + Math.random() * 9000).toString();

                const initialData = {
                    code, hostId: user.uid, status: 'lobby', createdAt: Date.now(),
                    players: [{ uid: user.uid, name: playerName.trim(), role: null, side: null }],
                    settings: { Percival: true, Morgana: true, Mordred: true, Oberon: false, Assassin: true, Lady: false },
                    gameState: {
                        round: 0, phase: 'night', leaderIdx: 0, team: [], votes: {},
                        missionVotes: {}, missionHistory: [], voteTrack: 0,
                        ladyIdx: -1,
                        logs: [`ğŸ‘‘ æˆ¿é–“å·²å»ºç«‹`]
                    }
                };
                try {
                    await setDoc(doc(db, 'avalon_rooms', code), initialData);
                    setRoomCode(code);
                } catch (err) { setLoading(false); setError(err.message); }
            };

            const joinRoom = async (codeToJoin) => {
                if (!playerName.trim()) return setError('è«‹è¼¸å…¥æš±ç¨±');
                setLoading(true);
                const db = getDb();
                const ref = doc(db, 'avalon_rooms', codeToJoin);
                try {
                    await runTransaction(db, async (txn) => {
                        const docSnap = await txn.get(ref);
                        if (!docSnap.exists()) throw "æˆ¿é–“ä¸å­˜åœ¨";
                        const data = docSnap.data();
                        if (data.status !== 'lobby') throw "éŠæˆ²å·²é–‹å§‹";
                        if (data.players.some(p => p.uid === user.uid)) return;
                        txn.update(ref, { players: [...data.players, { uid: user.uid, name: playerName.trim() }] });
                    });
                    setRoomCode(codeToJoin);
                } catch (err) { setLoading(false); setError(typeof err === 'string' ? err : err.message); }
            };

            const updateGame = async (updates) => {
                if (!appInstance || !roomCode) return;
                await updateDoc(doc(getDb(), 'avalon_rooms', roomCode), updates);
            };

            const generateStartData = (currentPlayers, currentSettings) => {
                const p = [...currentPlayers];
                const s = currentSettings;
                let goods = ['Merlin']; if (s.Percival) goods.push('Percival');
                let evils = []; if (s.Mordred) evils.push('Mordred'); if (s.Morgana) evils.push('Morgana'); if (s.Oberon) evils.push('Oberon'); if (s.Assassin) evils.push('Assassin');

                const numEvil = { 5: 2, 6: 2, 7: 3, 8: 3, 9: 3, 10: 4 }[p.length] || 2;
                while (evils.length < numEvil) evils.push('Minion');
                while (evils.length > numEvil) evils.pop();
                while (goods.length + evils.length < p.length) goods.push('Servant');

                const deck = [...goods, ...evils].sort(() => Math.random() - 0.5);
                const newPlayers = p.map((pl, i) => ({ ...pl, role: deck[i], side: ROLES_CONFIG[deck[i]].side }));
                const initialLadyIdx = s.Lady ? p.length - 1 : -1;

                return {
                    players: newPlayers,
                    status: 'playing',
                    gameState: {
                        round: 0, phase: 'night', leaderIdx: 0, team: [], votes: {},
                        missionVotes: {}, missionHistory: [], voteTrack: 0,
                        ladyIdx: initialLadyIdx,
                        logs: [`ğŸ² éŠæˆ²é–‹å§‹ï¼${p.length}äººå±€ (${numEvil}å£äºº)${s.Lady ? 'ï¼ŒğŸ§š æ¹–ä¸­å¥³ç¥å·²å•Ÿç”¨' : ''}`]
                    }
                };
            };

            const startGame = async () => {
                if (roomData.players.length < 5) return alert('è‡³å°‘5äºº');
                const newData = generateStartData(roomData.players, roomData.settings);
                await updateGame(newData);
            };

            const restartGame = async () => {
                if (!confirm("ç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿå°‡é‡æ–°åˆ†é…èº«åˆ†ã€‚")) return;
                const simplePlayers = roomData.players.map(p => ({ uid: p.uid, name: p.name }));
                const newData = generateStartData(simplePlayers, roomData.settings);
                await updateGame(newData);
            };

            if (!user) return <div className="min-h-screen flex items-center justify-center text-slate-400">é€£ç·šä¸­...</div>;

            return (
                <div className="max-w-3xl mx-auto p-4 min-h-screen flex flex-col">
                    <header className="flex justify-between items-center mb-6">
                        <div className="flex items-center gap-3">
                            <Shield className="w-8 h-8 text-yellow-500" />
                            <h1 className="text-2xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-yellow-400 to-yellow-600">
                                é˜¿ç“¦éš† Online
                            </h1>
                        </div>
                        {roomCode && (
                            <div className="flex items-center gap-2 bg-slate-800 px-3 py-1 rounded-full text-sm border border-slate-700">
                                <span className="font-mono font-bold text-yellow-400 text-lg">{roomCode}</span>
                                <button onClick={() => copyToClipboard(roomCode)} className="p-1 hover:text-white">
                                    {copySuccess ? <Check size={14} className="text-green-500" /> : <Copy size={14} />}
                                </button>
                            </div>
                        )}
                    </header>

                    {error && <div className="bg-red-900/50 text-red-200 p-3 rounded mb-4">{error} <button onClick={() => setError('')} className="float-right"><X /></button></div>}

                    {!roomData ? (
                        <LobbyForm playerName={playerName} setPlayerName={setPlayerName} createRoom={createRoom} joinRoom={joinRoom} loading={loading} />
                    ) : roomData.status === 'lobby' ? (
                        <LobbyRoom user={user} roomData={roomData} isHost={roomData.hostId === user.uid} updateGame={updateGame} startGame={startGame} />
                    ) : (
                        <GameBoard
                            user={user} roomData={roomData} isHost={roomData.hostId === user.uid}
                            updateGame={updateGame} appInstance={appInstance} roomCode={roomCode}
                            restartGame={restartGame}
                        />
                    )}
                </div>
            );
        };

        const LobbyForm = ({ playerName, setPlayerName, createRoom, joinRoom, loading }) => {
            const [code, setCode] = useState('');
            return (
                <Card className="max-w-md mx-auto mt-10">
                    <div className="space-y-6">
                        <div>
                            <label className="text-sm text-slate-400">æ‚¨çš„æš±ç¨±</label>
                            <input value={playerName} onChange={e => setPlayerName(e.target.value)} className="w-full bg-slate-900 border border-slate-700 rounded p-3 mt-1 text-white" />
                        </div>
                        <Button onClick={createRoom} disabled={loading} className="w-full py-3">å»ºç«‹æ–°æˆ¿é–“</Button>
                        <div className="flex gap-2">
                            <input value={code} onChange={e => setCode(e.target.value)} placeholder="è¼¸å…¥æˆ¿è™Ÿ" className="flex-1 bg-slate-900 border border-slate-700 rounded p-3 text-center text-white" />
                            <Button onClick={() => joinRoom(code)} disabled={loading} variant="secondary">åŠ å…¥</Button>
                        </div>
                    </div>
                </Card>
            );
        };

        const LobbyRoom = ({ user, roomData, isHost, updateGame, startGame }) => {
            const movePlayer = (idx, dir) => {
                const newP = [...roomData.players];
                [newP[idx], newP[idx + dir]] = [newP[idx + dir], newP[idx]];
                updateGame({ players: newP });
            };
            const toggleSetting = (k) => updateGame({ [`settings.${k}`]: !roomData.settings[k] });

            return (
                <div className="grid md:grid-cols-2 gap-6">
                    <Card>
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><Users size={20} /> ç©å®¶ ({roomData.players.length})</h3>
                        <div className="space-y-2">
                            {roomData.players.map((p, i) => (
                                <div key={p.uid} className="flex justify-between items-center bg-slate-900/50 p-3 rounded border border-slate-700">
                                    <div className="flex items-center gap-2">
                                        <span className="w-6 h-6 rounded-full bg-slate-700 flex items-center justify-center text-xs">{i + 1}</span>
                                        <span className={p.uid === user.uid ? "text-yellow-400 font-bold" : ""}>{p.name}</span>
                                        {p.uid === roomData.hostId && <Crown size={14} className="text-yellow-500" />}
                                    </div>
                                    {isHost && (
                                        <div className="flex gap-1">
                                            <button onClick={() => movePlayer(i, -1)} disabled={i === 0} className="p-1 hover:bg-slate-700 rounded disabled:opacity-30"><ArrowUp size={16} /></button>
                                            <button onClick={() => movePlayer(i, 1)} disabled={i === roomData.players.length - 1} className="p-1 hover:bg-slate-700 rounded disabled:opacity-30"><ArrowDown size={16} /></button>
                                        </div>
                                    )}
                                </div>
                            ))}
                        </div>
                    </Card>
                    <div className="space-y-6">
                        <Card>
                            <h3 className="text-xl font-bold mb-4">éŠæˆ²è¨­å®š</h3>
                            <div className="grid grid-cols-2 gap-2">
                                {Object.keys(roomData.settings).map(k => (
                                    <label key={k} className="flex items-center justify-between bg-slate-900/30 p-2 rounded cursor-pointer hover:bg-slate-800">
                                        <span className="text-sm">{k === 'Lady' ? 'ğŸ§š æ¹–ä¸­å¥³ç¥' : ROLES_CONFIG[k].name}</span>
                                        <input type="checkbox" checked={roomData.settings[k]} onChange={() => toggleSetting(k)} disabled={!isHost} className="accent-blue-500 w-5 h-5" />
                                    </label>
                                ))}
                            </div>
                            <p className="text-xs text-slate-500 mt-2">*æ¹–ä¸­å¥³ç¥å»ºè­° 7 äººä»¥ä¸Šé–‹å•Ÿï¼Œæ–¼ä»»å‹™ 2,3,4 å¾Œç™¼å‹•ã€‚</p>
                        </Card>
                        {isHost ? <Button onClick={startGame} className="w-full py-4 text-lg" disabled={roomData.players.length < 5}><Play size={20} /> é–‹å§‹éŠæˆ²</Button> : <div className="text-center text-slate-500 animate-pulse">ç­‰å¾…æˆ¿ä¸»é–‹å§‹...</div>}
                    </div>
                </div>
            );
        };

        const GameBoard = ({ user, roomData, isHost, updateGame, appInstance, roomCode, restartGame }) => {
            const { gameState, players, settings } = roomData;
            const me = players.find(p => p.uid === user.uid);
            const isLeader = players[gameState.leaderIdx].uid === user.uid;
            const missionSize = MISSION_MATRIX[players.length][gameState.round];
            const [showIdentity, setShowIdentity] = useState(false);

            const myRoleInfo = useMemo(() => {
                const r = ROLES_CONFIG[me.role];
                let info = `é™£ç‡Ÿï¼š${r.label}ã€‚`;
                let seen = [];
                if (me.role === 'Merlin') seen = players.filter(p => ROLES_CONFIG[p.role].side === 'evil' && p.role !== 'Mordred').map(p => p.name);
                if (me.role === 'Percival') seen = players.filter(p => ['Merlin', 'Morgana'].includes(p.role)).map(p => p.name);
                if (r.side === 'evil' && me.role !== 'Oberon') seen = players.filter(p => ROLES_CONFIG[p.role].side === 'evil' && p.role !== 'Oberon' && p.uid !== me.uid).map(p => p.name);
                if (seen.length) info += ` è¦–é‡ï¼š${seen.join(', ')}`;
                return { ...r, extra: info };
            }, [me, players]);

            const toggleTeam = (uid) => {
                if (!isLeader || gameState.phase !== 'team_selection') return;
                let t = [...gameState.team];
                t.includes(uid) ? t = t.filter(id => id !== uid) : (t.length < missionSize && t.push(uid));
                updateGame({ 'gameState.team': t });
            };

            const castVote = async (val) => {
                const db = getFirestore(appInstance);
                const ref = doc(db, 'avalon_rooms', roomCode);
                await runTransaction(db, async (txn) => {
                    const doc = await txn.get(ref);
                    const d = doc.data();
                    const newVotes = { ...d.gameState.votes, [user.uid]: val };
                    if (Object.keys(newVotes).length === d.players.length) {
                        const pass = Object.values(newVotes).filter(v => v).length > d.players.length / 2;
                        const logs = d.gameState.logs;
                        logs.push(pass ? `âœ… ææ¡ˆé€šé` : `âŒ ææ¡ˆå¦æ±º`);
                        let up = { 'gameState.votes': {}, 'gameState.logs': logs };
                        if (pass) {
                            up['gameState.phase'] = 'mission';
                            up['gameState.voteTrack'] = 0;
                        } else {
                            up['gameState.phase'] = 'team_selection';
                            up['gameState.team'] = [];
                            up['gameState.voteTrack'] = d.gameState.voteTrack + 1;
                            up['gameState.leaderIdx'] = (d.gameState.leaderIdx + 1) % d.players.length;
                            if (up['gameState.voteTrack'] >= 5) { up.status = 'finished'; logs.push('ğŸ’€ é€£çºŒ5æ¬¡å¦æ±ºï¼Œé‚ªæƒ¡å‹'); }
                        }
                        txn.update(ref, up);
                    } else {
                        txn.update(ref, { 'gameState.votes': newVotes });
                    }
                });
            };

            const castMission = async (success) => {
                const db = getFirestore(appInstance);
                const ref = doc(db, 'avalon_rooms', roomCode);
                await runTransaction(db, async (txn) => {
                    const doc = await txn.get(ref);
                    const d = doc.data();
                    const newMV = { ...d.gameState.missionVotes, [user.uid]: success ? 'success' : 'fail' };
                    if (Object.keys(newMV).length === d.gameState.team.length) {
                        const moves = Object.values(newMV);
                        const fails = moves.filter(m => m === 'fail').length;
                        const needsTwoFails = (d.players.length >= 7 && d.gameState.round === 3);
                        const isSuccess = fails < (needsTwoFails ? 2 : 1);
                        const newHist = [...d.gameState.missionHistory, { success: isSuccess, failCount: fails }];
                        const logs = d.gameState.logs;
                        logs.push(`ğŸ›¡ï¸ ä»»å‹™${d.gameState.round + 1} ${isSuccess ? 'æˆåŠŸ' : 'å¤±æ•—'} (é»‘å¡:${fails})`);

                        let up = {
                            'gameState.missionVotes': {}, 'gameState.missionHistory': newHist, 'gameState.logs': logs,
                            'gameState.team': []
                        };

                        const wins = newHist.filter(h => h.success).length;
                        const loss = newHist.filter(h => !h.success).length;

                        if (loss >= 3) {
                            up.status = 'finished'; logs.push('ğŸ’€ ä»»å‹™å¤±æ•—3æ¬¡ï¼Œé‚ªæƒ¡å‹');
                        } else if (wins >= 3) {
                            if (d.settings.Assassin) { up['gameState.phase'] = 'assassination'; logs.push('ğŸ—¡ï¸ åˆºå®¢åˆºæ®ºéšæ®µ'); }
                            else { up.status = 'finished'; logs.push('ğŸ† æ­£ç¾©å‹'); }
                        } else {
                            const nextRound = d.gameState.round + 1;
                            up['gameState.round'] = nextRound;
                            up['gameState.leaderIdx'] = (d.gameState.leaderIdx + 1) % d.players.length;
                            const justFinishedRound = d.gameState.round;
                            if (d.settings.Lady && d.gameState.ladyIdx !== -1 && (justFinishedRound >= 1 && justFinishedRound <= 3)) {
                                up['gameState.phase'] = 'lady_of_the_lake';
                                logs.push('ğŸ§š é€²å…¥æ¹–ä¸­å¥³ç¥éšæ®µ');
                            } else {
                                up['gameState.phase'] = 'team_selection';
                            }
                        }
                        txn.update(ref, up);
                    } else {
                        txn.update(ref, { 'gameState.missionVotes': newMV });
                    }
                });
            };

            const performLadyAction = async (targetUid) => {
                const targetIdx = players.findIndex(p => p.uid === targetUid);
                const targetP = players[targetIdx];
                const r = ROLES_CONFIG[targetP.role];
                const isGood = r.side === 'good';
                alert(`ğŸ§š å¥³ç¥æŸ¥é©—çµæœï¼š\n\nç©å®¶ [${targetP.name}] æ˜¯ [${isGood ? 'æ­£ç¾©' : 'é‚ªæƒ¡'}] æ–¹`);
                updateGame({
                    'gameState.phase': 'team_selection',
                    'gameState.ladyIdx': targetIdx,
                    'gameState.logs': arrayUnion(`ğŸ§š ${players[gameState.ladyIdx].name} æŸ¥é©—äº† ${targetP.name}ï¼Œå¥³ç¥æ¨™è¨˜å·²è½‰ç§»`)
                });
            };

            const assassinate = async (uid) => {
                const target = players.find(p => p.uid === uid);
                let msg = target.role === 'Merlin' ? 'ğŸ’€ åˆºæ®ºæ¢…æ—æˆåŠŸï¼Œé‚ªæƒ¡é€†è½‰å‹ï¼' : `ğŸ›¡ï¸ åˆºæ®ºå¤±æ•— (${target.name}ä¸æ˜¯æ¢…æ—)ï¼Œæ­£ç¾©å‹ï¼`;
                updateGame({ status: 'finished', 'gameState.logs': arrayUnion(msg), 'gameState.phase': 'end' });
            };

            const isMyTurnLady = (gameState.phase === 'lady_of_the_lake' && players[gameState.ladyIdx]?.uid === user.uid);

            return (
                <div className="grid lg:grid-cols-12 gap-6 pb-20">
                    <div className="lg:col-span-8 space-y-6">
                        <div className="flex justify-between items-center bg-slate-800 p-4 rounded-xl border border-slate-700">
                            <div className="flex gap-2">
                                {MISSION_MATRIX[players.length].map((c, i) => {
                                    const h = gameState.missionHistory[i];
                                    let col = "bg-slate-700 text-slate-400";
                                    if (h) col = h.success ? "bg-blue-600 text-white" : "bg-red-600 text-white";
                                    if (i === gameState.round) col = "bg-yellow-600/50 text-yellow-100 ring-2 ring-yellow-500";
                                    return <div key={i} className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${col}`}>{c}</div>
                                })}
                            </div>
                            <div className={`px-3 py-1 rounded bg-slate-900 border border-slate-700 text-xs text-center ${gameState.voteTrack >= 4 ? 'text-red-500' : 'text-white'}`}>
                                å¦æ±º<br /><span className="text-lg font-bold">{gameState.voteTrack}/5</span>
                            </div>
                        </div>

                        <Card className="min-h-[150px] flex flex-col justify-center items-center text-center p-6 bg-gradient-to-b from-slate-800 to-slate-900 border-yellow-500/30 relative overflow-hidden">
                            <h2 className="text-xl font-bold mb-4 text-yellow-100 z-10">
                                {gameState.phase === 'night' && 'è«‹ç¢ºèªèº«åˆ†'}
                                {gameState.phase === 'team_selection' && `é ˜è¢– ${players[gameState.leaderIdx].name} é¸æ“‡éšŠä¼ (${gameState.team.length}/${missionSize})`}
                                {gameState.phase === 'voting' && 'æŠ•ç¥¨ä¸­...'}
                                {gameState.phase === 'mission' && 'ä»»å‹™åŸ·è¡Œä¸­...'}
                                {gameState.phase === 'assassination' && 'åˆºå®¢åˆºæ®ºä¸­...'}
                                {gameState.phase === 'lady_of_the_lake' && `ğŸ§š æ¹–ä¸­å¥³ç¥ï¼š${players[gameState.ladyIdx].name} è«‹é¸æ“‡æŸ¥é©—å°è±¡`}
                                {roomData.status === 'finished' && (
                                    <span className={gameState.logs[gameState.logs.length - 1].includes('æ­£ç¾©') ? "text-emerald-400" : "text-red-400"}>
                                        {gameState.logs[gameState.logs.length - 1]}
                                    </span>
                                )}
                            </h2>
                            <div className="flex gap-4 flex-wrap justify-center z-10">
                                {gameState.phase === 'night' && isLeader && <Button onClick={() => updateGame({ 'gameState.phase': 'team_selection' })}>çµæŸå¤œæ™š</Button>}
                                {gameState.phase === 'team_selection' && isLeader && <Button onClick={() => updateGame({ 'gameState.phase': 'voting', 'gameState.logs': arrayUnion(`ğŸ—³ï¸ éšŠä¼ç¢ºèªï¼Œè«‹æŠ•ç¥¨`) })} disabled={gameState.team.length !== missionSize}>ç¢ºèªéšŠä¼</Button>}
                                {gameState.phase === 'voting' && gameState.votes[user.uid] === undefined && (
                                    <>
                                        <Button onClick={() => castVote(true)} className="bg-white text-black hover:bg-slate-200">âšª è´Šæˆ</Button>
                                        <Button onClick={() => castVote(false)} className="bg-black text-white border hover:bg-slate-900">âš« åå°</Button>
                                    </>
                                )}
                                {gameState.phase === 'mission' && gameState.team.includes(user.uid) && !gameState.missionVotes[user.uid] && (
                                    <>
                                        <Button onClick={() => castMission(true)} variant="success">ä»»å‹™æˆåŠŸ</Button>
                                        {me.side === 'evil' && <Button onClick={() => castMission(false)} variant="danger">ä»»å‹™å¤±æ•—</Button>}
                                    </>
                                )}
                                {gameState.phase === 'lady_of_the_lake' && isMyTurnLady && <div className="text-sm text-yellow-300 animate-pulse">è«‹é»æ“Šä¸‹æ–¹ç©å®¶é ­åƒé€²è¡ŒæŸ¥é©—</div>}
                                {roomData.status === 'finished' && isHost && <Button onClick={restartGame} variant="warning" className="mt-2"><RefreshCw size={18} /> é‡æ–°é–‹å§‹éŠæˆ²</Button>}
                            </div>
                        </Card>

                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
                            {players.map((p, i) => {
                                const isSel = gameState.team.includes(p.uid);
                                const isLdr = i === gameState.gameState?.leaderIdx;
                                const isLady = i === gameState.ladyIdx;
                                const vote = gameState.votes[p.uid];

                                const handleClick = () => {
                                    if (gameState.phase === 'team_selection') toggleTeam(p.uid);
                                    if (gameState.phase === 'assassination' && me.role === 'Assassin' && confirm(`åˆºæ®º ${p.name}?`)) assassinate(p.uid);
                                    if (gameState.phase === 'lady_of_the_lake' && isMyTurnLady) {
                                        if (p.uid === user.uid) return alert("ä¸èƒ½æŸ¥é©—è‡ªå·±");
                                        if (confirm(`ç¢ºå®šè¦æŸ¥é©— ${p.name} çš„é™£ç‡Ÿå—ï¼Ÿ`)) performLadyAction(p.uid);
                                    }
                                };

                                return (
                                    <div key={p.uid} onClick={handleClick}
                                        className={`relative p-3 rounded border cursor-pointer transition-all 
                                            ${isSel ? 'bg-blue-900/40 border-blue-500 shadow-lg shadow-blue-500/20' : 'bg-slate-800 border-slate-700'} 
                                            ${isLdr ? 'ring-2 ring-yellow-500' : ''}
                                            ${gameState.phase === 'lady_of_the_lake' && isMyTurnLady && p.uid !== user.uid ? 'hover:bg-purple-900/50 hover:border-purple-400' : ''}
                                        `}
                                    >
                                        <div className="flex justify-between mb-2">
                                            <span className="font-bold truncate text-sm">{p.name}</span>
                                            <div className="flex gap-1">
                                                {isLdr && <Crown size={14} className="text-yellow-500" />}
                                                {settings.Lady && isLady && <Sparkles size={14} className="text-purple-400" />}
                                            </div>
                                        </div>
                                        <div className="flex gap-1 items-center min-h-[20px]">
                                            {gameState.phase === 'voting' && (
                                                vote === undefined ? <div className="w-4 h-4 rounded-full border border-slate-600" /> :
                                                    vote === true ? <Check size={16} className="text-green-500" /> :
                                                        <X size={16} className="text-red-500" />
                                            )}
                                            {isSel && <Shield size={16} className="text-blue-400" />}
                                        </div>
                                        {roomData.status === 'finished' && <div className={`mt-2 text-xs px-1 rounded ${ROLES_CONFIG[p.role].side === 'good' ? 'text-green-300' : 'text-red-300'}`}>{ROLES_CONFIG[p.role].name}</div>}
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    <div className="lg:col-span-4 space-y-6">
                        <div className="bg-gradient-to-br from-indigo-900 to-slate-900 p-1 rounded-xl shadow-2xl">
                            <div className="bg-slate-900/90 p-4 rounded-lg relative min-h-[140px] flex flex-col">
                                <div className="flex justify-between items-center mb-4">
                                    <h3 className="text-indigo-300 text-xs font-bold uppercase">ä½ çš„èº«åˆ†</h3>
                                    <button onClick={() => setShowIdentity(!showIdentity)} className="text-slate-400 hover:text-white">
                                        {showIdentity ? <EyeOff size={18} /> : <Eye size={18} />}
                                    </button>
                                </div>
                                {showIdentity ? (
                                    <div className="fade-in">
                                        <div className="flex items-center gap-2 mb-2">
                                            <div className="text-2xl font-black">{myRoleInfo.name}</div>
                                            <Badge type={myRoleInfo.side}>{myRoleInfo.label}</Badge>
                                        </div>
                                        <p className="text-xs text-indigo-200 border-t border-indigo-500/30 pt-2 leading-relaxed">{myRoleInfo.extra}</p>
                                    </div>
                                ) : (
                                    <div onClick={() => setShowIdentity(true)} className="flex-1 flex flex-col items-center justify-center text-slate-500 cursor-pointer hover:text-slate-300 transition-colors">
                                        <Eye size={32} className="mb-2 opacity-50" />
                                        <span className="text-sm">é»æ“Šé¡¯ç¤ºèº«åˆ†</span>
                                    </div>
                                )}
                            </div>
                        </div>

                        <Card className="max-h-[400px] overflow-y-auto flex flex-col-reverse bg-slate-900/50">
                            <div className="space-y-1">
                                {[...gameState.logs].reverse().map((l, i) => <div key={i} className="text-sm text-slate-400 border-b border-slate-800 pb-1">{l}</div>)}
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>
